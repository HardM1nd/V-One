name: Deploy (SSH + docker compose)

on:
  workflow_dispatch:
    inputs:
      compose_file:
        description: "docker compose file path on server"
        required: false
        default: "docker-compose.prod.yml"
      project_dir:
        description: "project directory on server"
        required: false
        default: "/opt/v-one"

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ (secrets.DEPLOY_PORT != '' && secrets.DEPLOY_PORT) || '22' }}
          script: |
            set -euo pipefail
            cd "${{ inputs.project_dir }}"

            git fetch --all --prune
            git checkout --force "${{ github.ref_name }}"
            git reset --hard "origin/${{ github.ref_name }}"

            docker compose -f "${{ inputs.compose_file }}" pull
            docker compose -f "${{ inputs.compose_file }}" up -d --remove-orphans

            docker image prune -f

